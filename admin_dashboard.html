<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿç©ºç”»ä½œç®¡ç†é¢æ¿</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* æ·±é»‘è“è‰²èƒŒæ™¯ */
            min-height: 100vh;
        }
        /* å¡ç‰‡æ ·å¼ï¼Œæ¨¡æ‹Ÿå‘å…‰æ•ˆæœ */
        .drawing-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: #161b22; /* ç¨äº®çš„èƒŒæ™¯ */
            border: 1px solid #30363d;
        }
        .drawing-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(56, 139, 253, 0.2); /* è“è‰²é˜´å½± */
        }
        /* ç¡®ä¿å›¾ç‰‡èƒŒæ™¯æ˜¯é€æ˜çš„ï¼Œåªæ˜¾ç¤ºæ˜Ÿå…‰ */
        .drawing-image {
            background-color: #0d1117;
            object-fit: contain;
        }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆªå’Œä¿¡æ¯ -->
    <header class="bg-[#161b22] shadow-lg p-6 mb-8 border-b border-gray-700">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-extrabold text-blue-400 mb-1">
                â­ æ˜Ÿç©ºç”»ä½œå®æ—¶é¢æ¿
            </h1>
            <p class="text-gray-400 text-sm">
                åº”ç”¨ID: <span id="app-id-display" class="font-mono text-blue-300">Loading...</span>
            </p>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- åŠ è½½å’Œé”™è¯¯ä¿¡æ¯ -->
        <p id="loading-message" class="text-center text-xl text-blue-400 font-medium my-10">
            æ­£åœ¨è¿æ¥ Firebase å¹¶åŠ è½½ç”»ä½œ...
        </p>

        <!-- ç”»ä½œå®¹å™¨ -->
        <div id="drawings-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-12">
            <!-- ç”»ä½œå°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // ã€å…³é”®ä¿®å¤ 1ã€‘æ‰‹åŠ¨ç¡¬ç¼–ç  Firebase é…ç½®
        // æ‚¨çš„ Firebase é¡¹ç›®é…ç½®ä¿¡æ¯: spacekisses-bc8df
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCTdORA5WDB8FCgFGh9Sly1CRirFhQlP0E",
            authDomain: "spacekisses-bc8df.firebaseapp.com",
            projectId: "spacekisses-bc8df",
            storageBucket: "spacekisses-bc8df.firebasestorage.app",
            messagingSenderId: "815021637918",
            appId: "1:815021637918:web:5168dd81dbe63326edc90f",
            measurementId: "G-3C3B8CB2QF"
        };

        // ã€å…³é”®ä¿®å¤ 2ã€‘ä½¿ç”¨ projectId ä½œä¸º App IDï¼Œç”¨äºæ„å»º Firestore è·¯å¾„
        const appId = FIREBASE_CONFIG.projectId || 'star-drawing-app-default';

        document.getElementById('app-id-display').textContent = appId;
        const container = document.getElementById('drawings-container');
        const loadingMessage = document.getElementById('loading-message');

        let db;

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                // ä½¿ç”¨æ‰‹åŠ¨å®šä¹‰çš„é…ç½®åˆå§‹åŒ– Firebase
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                const auth = getAuth(app);

                // ç»Ÿä¸€ä½¿ç”¨åŒ¿åç™»å½•
                await signInAnonymously(auth);

                // Wait for auth state change
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Admin panel: Authenticated. Starting listener.");
                        // è®¤è¯æˆåŠŸåæ‰å¼€å§‹ç›‘å¬æ•°æ®åº“
                        startListeningForDrawings();
                    } else {
                        console.error("Admin panel: Authentication failed or not ready. Check Firebase Auth setup.");
                        loadingMessage.textContent = 'é”™è¯¯ï¼šç”¨æˆ·è®¤è¯å¤±è´¥ã€‚';
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingMessage.textContent = 'é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œã€‚';
            }
        }

        // --- Real-time Data Listener ---
        function startListeningForDrawings() {
            // è·¯å¾„æ„å»º: /artifacts/{spacekisses-bc8df}/public/data/star_drawings
            const collectionPath = `artifacts/${appId}/public/data/star_drawings`;
            const drawingsQuery = query(collection(db, collectionPath));

            console.log(`Listening to collection: ${collectionPath}`);
            loadingMessage.textContent = 'ç­‰å¾…ç”»ä½œä¸­...';

            // å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–
            onSnapshot(drawingsQuery, (snapshot) => {
                container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

                if (snapshot.empty) {
                    loadingMessage.textContent = 'ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•ç”»ä½œã€‚';
                    return;
                }

                loadingMessage.textContent = ''; // éšè—åŠ è½½ä¿¡æ¯

                // å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„ï¼Œå¹¶æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
                const drawings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    drawings.push({
                        id: doc.id,
                        ...data
                    });
                });

                // åœ¨å®¢æˆ·ç«¯è¿›è¡Œæ’åºï¼šæŒ‰æ—¶é—´æˆ³é™åº (æœ€æ–°åœ¨å‰)
                drawings.sort((a, b) => b.timestamp - a.timestamp);

                drawings.forEach(data => {
                    const timestamp = new Date(data.timestamp);
                    const formattedTime = timestamp.toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });

                    const card = document.createElement('div');
                    card.className = 'drawing-card rounded-xl overflow-hidden shadow-2xl';

                    // ç”»å¸ƒåŒºåŸŸ (æ˜¾ç¤ºå›¾ç‰‡)
                    card.innerHTML = `
                        <div class="relative w-full aspect-square drawing-image p-2 rounded-t-xl">
                            <!-- Base64 æ•°æ®ç›´æ¥ä½œä¸ºå›¾ç‰‡æº -->
                            <img src="${data.drawingData}" alt="User Star Drawing"
                                 class="w-full h-full object-contain filter drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]">
                        </div>

                        <!-- ä¿¡æ¯åŒºåŸŸ -->
                        <div class="p-4 space-y-2 text-sm text-gray-300">
                            <p class="font-semibold text-blue-300 truncate">
                                æ•°æ®åº“æ–‡æ¡£ID: <span class="font-mono text-xs">${data.id}</span>
                            </p>
                            <p>
                                ğŸ‘¤ ç”¨æˆ·ID: <span class="font-mono text-xs text-gray-500">${data.userId || 'N/A'}</span>
                            </p>
                            <p>
                                ğŸ•’ ä¸Šä¼ æ—¶é—´: ${formattedTime}
                            </p>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }, (error) => {
                console.error("Firestore real-time listener failed:", error);
                loadingMessage.textContent = `å®æ—¶ç›‘å¬å¤±è´¥ï¼šè¯·æ£€æŸ¥ Firestore å®‰å…¨è§„åˆ™ã€‚ (${error.message})`;
                container.innerHTML = '';
            });
        }

        window.onload = initializeFirebase;
    </script>

</body>
</html>
