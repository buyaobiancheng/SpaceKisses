<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星空绘图板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字体并设置全局黑色背景 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            margin: 0;
            overflow: hidden; /* 防止滑动时影响布局 */
        }
        /* 画布容器确保内容居中 */
        #canvas-container {
            touch-action: none; /* 禁用默认的触摸操作，防止滚屏 */
        }

        /* --- 优化滑块样式以匹配蓝色主题和现代感 --- */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #60a5fa; /* 亮蓝色 */
            cursor: pointer;
            /* 蓝色发光阴影 */
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.9);
            transition: all 0.2s ease-in-out;
        }

        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: #1e3a8a; /* 深蓝色轨道 */
            border-radius: 3px;
        }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">

    <header class="p-4 bg-[#060A1A] shadow-2xl shadow-blue-900/50 text-center">
        <h1 class="text-2xl font-extrabold text-blue-300 tracking-wider">
            绘制您的专属星光
        </h1>
    </header>

    <main id="canvas-container" class="flex-grow bg-black overflow-hidden relative">
        <canvas id="starCanvas" class="block w-full h-full"></canvas>
    </main>

    <footer class="bg-[#060A1A] p-4 border-t border-blue-900/50 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-6">

        <div class="flex items-center space-x-3 w-full sm:w-1/2">
            <span class="text-sm font-medium text-blue-200 whitespace-nowrap">画笔大小:</span>
            <input type="range" id="brushSize" min="2" max="30" value="10"
                   class="w-full h-2 bg-blue-900 rounded-lg appearance-none cursor-pointer">
            <span id="sizeValue" class="text-sm font-mono text-blue-300 w-8 text-right">10</span>
        </div>

        <div class="flex space-x-4 w-full sm:w-auto justify-center">
            <button id="uploadBtn"
                    class="px-8 py-2 bg-blue-500 text-white font-bold rounded-full shadow-xl shadow-blue-500/50 hover:bg-blue-400 transition duration-150 active:scale-95 disabled:opacity-40"
                    disabled>
                正在连接...
            </button>
        </div>

    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, addDoc, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // 【Firebase 配置】手动硬编码配置
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCTdORA5WDB8FCgFGh9Sly1CRirFhQlP0E",
            authDomain: "spacekisses-bc8df.firebaseapp.com",
            projectId: "spacekisses-bc8df",
            storageBucket: "spacekisses-bc8df.firebasestorage.app",
            messagingSenderId: "815021637918",
            appId: "1:815021637918:web:5168dd81dbe63326edc90f",
            measurementId: "G-3C3B8CB2QF"
        };

        const appId = FIREBASE_CONFIG.projectId || 'star-drawing-app-default';

        let db;
        let userId = null;
        let isFirebaseReady = false;

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                const auth = getAuth(app);

                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isFirebaseReady = true;
                        console.log("Firebase initialized. User ID:", userId);

                        // 认证成功后，启用按钮
                        document.getElementById('uploadBtn').disabled = false;
                        document.getElementById('uploadBtn').textContent = '上传画作';
                        document.getElementById('uploadBtn').classList.remove('bg-red-600');
                    } else {
                        console.error("Firebase Auth failed. Using fallback ID.");
                        userId = crypto.randomUUID();
                        document.getElementById('uploadBtn').textContent = '认证失败';
                        document.getElementById('uploadBtn').classList.add('bg-red-600');
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('uploadBtn').textContent = '连接失败 (请检查配置)';
                document.getElementById('uploadBtn').classList.add('bg-red-600');
            }
        }

        // --- Main Application Logic ---
        window.onload = function() {
            initializeFirebase(); // Start Firebase init

            const canvas = document.getElementById('starCanvas');
            const ctx = canvas.getContext('2d');
            const brushSizeInput = document.getElementById('brushSize');
            const sizeValueSpan = document.getElementById('sizeValue');
            const uploadBtn = document.getElementById('uploadBtn');

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let currentBrushSize = parseInt(brushSizeInput.value);

            // --- Canvas 初始化与响应式设置 ---

            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                setupContext();
                // 确保清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            // 【新增】清空画布函数
            function clearCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                setupContext(); // 重设上下文配置
            }

            function setupContext() {
                ctx.lineWidth = currentBrushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#ffffff';
                ctx.shadowColor = '#ffffff';
                ctx.shadowBlur = currentBrushSize * 0.8;
            }

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // 初始设置画布大小和样式

            // 【简化】移除 saveState, restoreState, updateUndoButtonState 函数

            function draw(e) {
                if (!isDrawing) return;

                let x, y;
                // 统一处理触摸和鼠标事件
                if (e.touches && e.touches.length > 0) {
                    const touch = e.touches[0];
                    x = touch.clientX - canvas.getBoundingClientRect().left;
                    y = touch.clientY - canvas.getBoundingClientRect().top;
                } else {
                    x = e.offsetX;
                    y = e.offsetY;
                }

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();

                [lastX, lastY] = [x, y];
            }

            function startDrawing(e) {
                isDrawing = true;

                let startX, startY;
                if (e.touches && e.touches.length > 0) {
                    const touch = e.touches[0];
                    startX = touch.clientX - canvas.getBoundingClientRect().left;
                    startY = touch.clientY - canvas.getBoundingClientRect().top;
                } else {
                    startX = e.offsetX;
                    startY = e.offsetY;
                }

                [lastX, lastY] = [startX, startY];
                draw(e);
            }

            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    // 【简化】移除 saveState 调用
                }
            }

            // --- 事件监听器 ---

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            document.addEventListener('mouseup', stopDrawing);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e);
            }, { passive: false });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            }, { passive: false });
            document.addEventListener('touchend', stopDrawing);

            brushSizeInput.addEventListener('input', () => {
                currentBrushSize = parseInt(brushSizeInput.value);
                sizeValueSpan.textContent = currentBrushSize;
                setupContext();
            });

            // 【更新】上传功能 - 上传后自动重置画布
            uploadBtn.addEventListener('click', async () => {
                // 检查画布是否为空（通过检查像素数据，简单实现）
                const isCanvasEmpty = !ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel > 0);
                if (isCanvasEmpty) {
                     showMessage('画板为空，请先绘制您的星光。', 'error');
                     return;
                }

                if (!isFirebaseReady || !db || !userId) {
                    showMessage('数据库未准备好，认证进行中，请稍候再试。', 'error');
                    return;
                }

                uploadBtn.disabled = true;
                uploadBtn.textContent = '上传中...';

                // 1. 暂时禁用发光效果，以确保导出的图像是干净的白色线条
                ctx.shadowBlur = 0;

                // 2. 将画布内容导出为透明背景的 PNG
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                const img = new Image();
                img.onload = async () => {
                    tempCtx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // 生成透明背景的 PNG Data URL
                    const transparentPNG = tempCanvas.toDataURL('image/png');

                    // 3. 恢复发光效果，以在 UI 上保持一致
                    setupContext();

                    try {
                        // 4. 上传到 Firestore 公共集合
                        const collectionPath = `artifacts/${appId}/public/data/star_drawings`;
                        await addDoc(collection(db, collectionPath), {
                            drawingData: transparentPNG, // Base64 Data URL
                            userId: userId,
                            timestamp: Date.now()
                        });

                        // 【关键修改】上传成功后清空画布
                        clearCanvas();
                        showMessage('上传成功！画板已清空，请绘制下一幅作品。', 'success');

                    } catch (error) {
                        console.error('上传到 Firestore 失败:', error);
                        showMessage('上传失败：数据库写入错误。', 'error');
                    } finally {
                        uploadBtn.disabled = false;
                        uploadBtn.textContent = '上传画作';
                    }
                };

                // 确保使用当前状态进行导出
                img.src = canvas.toDataURL();
            });


            // --- 自定义消息提示框函数 ---
            function showMessage(message, type) {
                const messageBox = document.createElement('div');
                messageBox.textContent = message;
                messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl text-white font-bold transition-all duration-300 z-50`;

                if (type === 'success') {
                    messageBox.classList.add('bg-blue-600');
                } else {
                    messageBox.classList.add('bg-red-600');
                }

                document.body.appendChild(messageBox);

                setTimeout(() => {
                    messageBox.classList.add('opacity-0');
                    messageBox.classList.add('scale-75');
                    messageBox.addEventListener('transitionend', () => messageBox.remove());
                }, 3000);
            }
        };

    </script>

</body>
</html>
